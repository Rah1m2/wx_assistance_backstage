<?xml version="1.0" encoding="UTF8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wx.main.DAO.SearchDAO">

    <!--select * from postings_info where article_content like CONCAT('%',#{query},'%')-->

    <select id="dynamicSearch" resultType="com.wx.main.POJO.Posting" parameterType="String">
        SELECT
        <choose>
         <when test="#{query} != null">
             DISTINCT postings_info.article_id,article_title,article_content,article_image,sort_id,tab_id,last_reply_time FROM postings_info LEFT JOIN comment_info
             ON
             postings_info.article_id = comment_info.article_id
             WHERE
                 postings_info.article_content LIKE CONCAT('%',#{query},'%')
                 OR
                 postings_info.article_title LIKE CONCAT('%',#{query},'%')
                 OR
                 comment_info.comment_content LIKE CONCAT('%',#{query},'%')
         </when>
         <otherwise>
             * from postings_info
         </otherwise>
       </choose>
    </select>
    
    <select id="getUserOpenidByArticleId" resultType="String" parameterType="int">
        select user_openid from postings_info where article_id=#{article_id}
    </select>

    <select id="searchAdmin" resultType="com.wx.main.POJO.User" parameterType="String">
        SELECT
            *
        FROM
            user_info
        WHERE
            user_info.user_name LIKE CONCAT('%',#{query},'%')
            OR
            user_info.user_openid LIKE CONCAT('%',#{query},'%')
            OR
            user_info.user_language LIKE CONCAT('%',#{query},'%')
            OR
            user_info.user_country LIKE CONCAT('%',#{query},'%')
            OR
            user_info.user_avatarUrl LIKE CONCAT('%',#{query},'%')
    </select>

    <select id="returnStatsMap" resultType="java.lang.Integer">
        select COUNT(*) from postings_info
        UNION ALL
        select COUNT(*) from user_info
        UNION ALL
        select COUNT(*) from mission_reserve_info
    </select>

    <select id="returnPostingCountGroupBySort" resultMap="sortMap">
        select DISTINCT sort_info.sort_name,COUNT(*) count from postings_info INNER JOIN sort_info where postings_info.sort_id=sort_info.sort_id
        GROUP BY sort_info.sort_id
    </select>
    
    <resultMap id="sortMap" type="java.util.HashMap">
        <result property="name" column="sort_name"/>
        <result property="value" column="count"/>
    </resultMap>


</mapper>